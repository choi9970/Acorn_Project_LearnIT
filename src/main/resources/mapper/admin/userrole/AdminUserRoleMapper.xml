<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.admin.userrole.mapper.AdminUserRoleMapper">

    <select id="isGlobalAdmin" resultType="int">
        SELECT COUNT(*)
        FROM admin_user_role aur
        JOIN admin_role ar ON ar.admin_role_id = aur.admin_role_id
        WHERE aur.user_id = #{userId}
        AND ar.code = 'ADMIN'
    </select>

    <select id="findAdminRoleIdByCode" resultType="int">
        SELECT admin_role_id
        FROM admin_role
        WHERE code = #{code}
    </select>

    <!-- 정책 체크용 -->
    <select id="findUserPolicy" resultType="map">
        SELECT
        user_id AS userId,
        status  AS status,
        role    AS role,
        provider AS provider
        FROM users
        WHERE user_id = #{userId}
    </select>

    <sql id="userSearchWhere">
        <where>
            <if test="type == 'email' and keyword != null and keyword != ''">
                AND email LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type == 'name' and keyword != null and keyword != ''">
                AND name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type == 'userId' and keyword != null and keyword != ''">
                AND user_id = #{keyword}
            </if>
        </where>
    </sql>

    <select id="countUsers" resultType="int">
        SELECT COUNT(*)
        FROM users
        <include refid="userSearchWhere"/>
    </select>

    <!-- 응답은 Map으로(기존 DTO 재사용 가능성이 높고, DTO 강제 생성 불필요) -->
    <select id="searchUsers" resultType="map">
        SELECT
        user_id AS userId,
        name    AS name,
        email   AS email,
        status  AS status,
        role    AS role,
        provider AS provider
        FROM users
        <include refid="userSearchWhere"/>
        ORDER BY user_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- SUB_ADMIN 관리 강의 목록 -->
    <select id="findManagedCourses" resultType="map">
        SELECT
        c.course_id AS courseId,
        c.title     AS title
        FROM admin_user_role aur
        JOIN admin_role ar ON ar.admin_role_id = aur.admin_role_id
        JOIN course c ON c.course_id = aur.course_id
        WHERE aur.user_id = #{userId}
        AND ar.code = 'SUB_ADMIN'
        ORDER BY c.course_id DESC
    </select>

    <update id="updateUserRole">
        UPDATE users
        SET role = #{role}, updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

    <update id="updateUserStatus">
        UPDATE users
        SET status = #{status}, updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- SIGNUP_PENDING(소셜) -> ACTIVE 강제 -->
    <update id="forceActivateSocialPending">
        UPDATE users
        SET
        nickname = #{nickname},
        phone = #{phone},
        status = 'ACTIVE',
        email_verified = 'Y',
        updated_at = NOW()
        WHERE user_id = #{userId}
    </update>

    <delete id="deleteAdminUserRoles">
        DELETE FROM admin_user_role
        WHERE user_id = #{userId}
    </delete>

    <insert id="insertAdminUserRole">
        INSERT INTO admin_user_role (user_id, admin_role_id, course_id)
        VALUES (#{userId}, #{adminRoleId}, #{courseId})
    </insert>

    <!-- 강의 검색 (delete_flg=0만) -->
    <select id="countCourses" resultType="int">
        SELECT COUNT(*)
        FROM course
        WHERE delete_flg = 0
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>

    <select id="searchCourses" resultType="map">
        SELECT
        course_id AS courseId,
        title     AS title
        FROM course
        WHERE delete_flg = 0
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY course_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>
